#!/bin/sh

# Get building date
date="`date +%y`"/"`date +%m`"
build="`date +%Y%m%d`"

# Include configuration file
. ./flagship.conf

# Start with non-optional apponly flags
APPONLYFLAGS="-DVERSION=\\\"${date}\\\",-DBUILD=\\\"${build}\\\",-DUSE_PREPROC_F90CPP"
MESSAGE=""

# Add flags for transport model
if [ -n "$TRANSP_USE_IBP" -a "$TRANSP_USE_IBP" = "YES" ]
then
  APPONLYFLAGS="$APPONLYFLAGS,-DTRANSP_USE_IBP"
  MESSAGE="TRANSP_USE_IBP = YES"
else
  MESSAGE="TRANSP_USE_IBP = NO"
fi

# Add flags for hydrodynamic model
if [ -n "$HYDRO_USE_IBP" -a "$HYDRO_USE_IBP" = "YES" ]
then
  APPONLYFLAGS="$APPONLYFLAGS,-DHYDRO_USE_IBP"
  MESSAGE="$MESSAGE\nHYDRO_USE_IBP = YES"
else
  MESSAGE="$MESSAGE\nHYDRO_USE_IBP = NO"
fi

if [ -n "$HYDRO_USE_ENTROPYFIX" -a "$HYDRO_USE_ENTROPYFIX" = "YES" ]
then
  APPONLYFLAGS="$APPONLYFLAGS,-DHYDRO_USE_ENTROPYFIX"
  MESSAGE="$MESSAGE\nHYDRO_USE_ENTROPYFIX = YES"
else
  MESSAGE="$MESSAGE\nHYDRO_USE_ENTROPYFIX = NO"
fi

if [ -n "$HYDRO_GAMMA" ]
then
    APPONLYFLAGS="$APPONLYFLAGS,-DHYDRO_GAMMA=${HYDRO_GAMMA}"
    MESSAGE="$MESSAGE\nHYDRO_GAMMA = ${HYDRO_GAMMA}"
fi

# Add flags for MHD model
if [ -n "$MHD_USE_IBP" -a "$MHD_USE_IBP" = "YES" ]
then
  APPONLYFLAGS="$APPONLYFLAGS,-DMHD_USE_IBP"
  MESSAGE="$MESSAGE\nMHD_USE_IBP = YES"
else
  MESSAGE="$MESSAGE\nMHD_USE_IBP = NO"
fi

if [ -n "$MHD_USE_ENTROPYFIX" -a "$MHD_USE_ENTROPYFIX" = "YES" ]
then
  APPONLYFLAGS="$APPONLYFLAGS,-DMHD_USE_ENTROPYFIX"
  MESSAGE="$MESSAGE\nMHD_USE_ENTROPYFIX = YES"
else
  MESSAGE="$MESSAGE\nMHD_USE_ENTROPYFIX = NO"
fi

if [ -n "$MHD_GAMMA" ]
then
    APPONLYFLAGS="$APPONLYFLAGS,-DMHD_GAMMA=${MHD_GAMMA}"
    MESSAGE="$MESSAGE\nMHD_GAMMA = ${MHD_GAMMA}"
fi

if [ -n "$MHD_VACUUM_PERM" ]
then
    APPONLYFLAGS="$APPONLYFLAGS,-DMHD_VACUUM_PERM=${MHD_VACUUM_PERM}"
    MESSAGE="$MESSAGE\nMHD_VACUUM_PERM = ${MHD_VACUUM_PERM}"
fi

if [ -n "$MHD_X_MAGNETICFIELD_CONSTANT_1D" ]
then
    APPONLYFLAGS="$APPONLYFLAGS,-DMHD_X_MAGNETICFIELD_CONSTANT_1D=${MHD_X_MAGNETICFIELD_CONSTANT_1D}"
    MESSAGE="$MESSAGE\nMHD_X_MAGNETICFIELD_CONSTANT_1D = ${MHD_X_MAGNETICFIELD_CONSTANT_1D}"
fi


# Use system-wide configure
../../bin/configure \
    --appname=flagship \
    --programfile=src/flagship.f90 \
    --srclist_app="`ls src/*.f90 src/models/*/*.f90 src/kernel/*.f90`" \
    --header-files-to-copy=src/flagship.h \
    --header-files-to-copy=src/models/hydro/hydro.h \
    --header-files-to-copy=src/models/mhd/mhd.h \
    --header-files-to-copy=src/kernel/thermodynamics.h \
    --header-files-to-copy=src/kernel/magnetohydrodynamics.h \
    --apponlyflags="$APPONLYFLAGS"\
    $@

echo "Application will be compiled with the following flags:\n"
echo $MESSAGE